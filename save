from django.shortcuts import render, get_object_or_404
from django.views.generic import DetailView
from discounts_app import models

from django.shortcuts import render
from .models import DiscountCategory, DiscountCard, City


def categories_view(request):
    categories = DiscountCategory.objects.all()
    discounts = DiscountCard.objects.all()

    selected_discount_id = request.GET.get('selected')
    selected_discount = None

    if selected_discount_id:
        try:
            selected_discount = DiscountCard.objects.get(id=selected_discount_id)
        except DiscountCard.DoesNotExist:
            pass

    context = {
        'categories': categories,
        'discounts': discounts,
        'selected_discount': selected_discount
    }
    return render(request, 'categories.html', context)


def category_discounts_view(request, category_id):
    category = get_object_or_404(DiscountCategory, id=category_id)
    cities = City.objects.all()

    city_id = request.session.get('city_id')
    selected_city = City.objects.filter(id=city_id).first() if city_id else City.objects.filter(name='Уфа').first()

    if 'set_city' in request.GET:
        try:
            selected_city = City.objects.get(id=request.GET.get('set_city'))
            request.session['city_id'] = selected_city.id
        except City.DoesNotExist:
            pass

    discounts = DiscountCard.objects.filter(categories=category, cities=selected_city)

    selected_discount_id = request.GET.get('selected')
    selected_discount = None

    if selected_discount_id:
        try:
            selected_discount = DiscountCard.objects.get(id=selected_discount_id, categories=category)
        except DiscountCard.DoesNotExist:
            pass

    return render(request, 'discounts.html', {
        'category': category,
        'discounts': discounts,
        'selected_discount': selected_discount,
        'cities': cities
    })